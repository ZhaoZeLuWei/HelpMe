<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title> 个人中心 </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  @if (!isLoggedIn) {
  <!-- 未登录时显示登录提示 -->
  <div class="login-prompt">
    <ion-icon name="person-circle" class="prompt-icon"></ion-icon>
    <h2>欢迎使用 HelpMe</h2>
    <p>登录后查看个人中心</p>
    <div class="auth-buttons">
      <ion-button (click)="openLoginModal()">立即登录</ion-button>
      <ion-button fill="outline" (click)="openRegisterModal()"
        >注册账号</ion-button
      >
    </div>
  </div>
  } @if (isLoggedIn) {
  <!-- 用户信息 -->
  <ion-card class="user-card">
    <!-- 头部区域：头像和基本信息 -->
    <div class="user-header">
      <div class="avatar-section">
        <ion-avatar class="user-avatar">
          @if (userInfo.avatar) {
          <img [src]="getAssetUrl(userInfo.avatar)" alt="avatar" />
          } @else {
          <ion-icon name="person-circle"></ion-icon>
          }
        </ion-avatar>
      </div>
      <div class="user-basic-info">
        <div class="user-name-row">
          <h2 class="user-name">{{ userInfo.name }}</h2>
          <ion-badge
            class="verified-badge"
            [color]="getVerificationColor(userInfo.isVerified)"
          >
            {{ userInfo.isVerified }}
          </ion-badge>
        </div>
        <div class="user-location">
          <ion-icon name="location-outline"></ion-icon>
          <span>{{ userInfo.location || '未设置位置' }}</span>
        </div>
      </div>
    </div>

    <!-- 个人介绍 -->
    <div class="user-intro-section">
      <p class="user-intro">
        {{ userInfo.introduction || '个人的介绍，等待以后再来探索吧！' }}
      </p>
    </div>

    <!-- 评分信息 -->
    <div class="user-ratings">
      <div class="rating-item">
        <ion-icon name="star" color="warning"></ion-icon>
        <div class="rating-content">
          <span class="rating-label">买家评分</span>
          <span class="rating-value"
            >{{ formatRating(userInfo.buyerRanking) }}</span
          >
        </div>
      </div>
      <div class="rating-item">
        <ion-icon name="ribbon" color="primary"></ion-icon>
        <div class="rating-content">
          <span class="rating-label">服务评分</span>
          <span class="rating-value"
            >{{ formatRating(userInfo.serviceRanking) }}</span
          >
        </div>
      </div>
      <div class="rating-item">
        <ion-icon name="briefcase" color="success"></ion-icon>
        <div class="rating-content">
          <span class="rating-label">服务单数</span>
          <span class="rating-value">{{ userInfo.orderCount || 0 }}</span>
        </div>
      </div>
    </div>

    <!-- 操作按钮 -->
    <div class="user-button-group">
      <ion-button fill="outline" size="small" (click)="openEditProfileModal()">
        <ion-icon name="create-outline" slot="start"></ion-icon>
        编辑资料
      </ion-button>
      <ion-button color="danger" fill="outline" size="small" (click)="logout()">
        <ion-icon name="log-out" slot="start"></ion-icon>
        登出
      </ion-button>
    </div>
    <div class="user-actions">
      <ion-button fill="outline" (click)="goToFollow()">
        <ion-icon name="heart-outline"></ion-icon>
        <span>关注({{ userInfo.stats.follows }})</span>
      </ion-button>
      <ion-button fill="outline" (click)="goToFavorites()">
        <ion-icon name="heart"></ion-icon>
        <span>收藏({{ userInfo.stats.favorites }})</span>
      </ion-button>
      <ion-button fill="outline" (click)="goToViews()">
        <ion-icon name="eye"></ion-icon>
        <span>浏览({{ userInfo.stats.views }})</span>
      </ion-button>
    </div>
  </ion-card>
  <!-- 分类标签 -->
  <ion-segment [value]="activeTab" (ionChange)="onTabChange($event)">
    <ion-segment-button value="published">
      <ion-icon name="document-text"></ion-icon>
      <ion-label>我发布的</ion-label>
    </ion-segment-button>
    <ion-segment-button value="inProgress">
      <ion-icon name="time"></ion-icon>
      <ion-label>正进行的</ion-label>
    </ion-segment-button>
    <ion-segment-button value="completed">
      <ion-icon name="checkmark-done"></ion-icon>
      <ion-label>已完成</ion-label>
    </ion-segment-button>
    <ion-segment-button value="review">
      <ion-icon name="star"></ion-icon>
      <ion-label>评价</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- 任务列表 -->
  <div class="tasks-list">
    @for (task of getFilteredTasks(); track task.id) {
    <ion-card class="task-item">
      <ion-item lines="none">
        <ion-icon
          name="document-text"
          slot="start"
          class="task-icon"
        ></ion-icon>
        <ion-label>
          <h2 class="task-title">{{ task.publisher }} · {{ task.title }}</h2>
          <p class="task-meta">发布时间: {{ task.createdAt }}</p>
        </ion-label>
        <ion-badge
          slot="end"
          [color]="getStatusColor(task.status)"
          class="status-badge"
        >
          {{ getStatusText(task.status) }}
        </ion-badge>
      </ion-item>
      <ion-item lines="none" class="task-actions">
        <ion-buttons slot="end">
          @if (task.status === 'published') {
          <ion-button
            [disabled]="deletingIds.has(task.id)"
            (click)="openDeleteAlert(task.id)"
          >
            @if (deletingIds.has(task.id)) { 删除中... } @else { 删除 }
          </ion-button>
          <ion-button (click)="editTask(task.id)">编辑</ion-button>
          } @if (task.status === 'inProgress') {
          <ion-button (click)="viewDetails(task.id)">详情</ion-button>
          } @if (task.status === 'completed') {
          <ion-button
            [disabled]="deletingIds.has(task.id)"
            (click)="openDeleteAlert(task.id)"
          >
            @if (deletingIds.has(task.id)) { 删除中... } @else { 删除 }
          </ion-button>
          <ion-button (click)="viewDetails(task.id)">详情</ion-button>
          } @if (task.status === 'review') {
          <ion-button (click)="goToReview(task.id)">评价</ion-button>
          }
        </ion-buttons>
      </ion-item>
    </ion-card>
    } @if (getFilteredTasks().length === 0) {
    <div class="empty-state">
      <ion-icon name="document-text" class="empty-icon"></ion-icon>
      <ion-text color="medium">
        <p>暂无相关任务</p>
      </ion-text>
    </div>
    }
  </div>

  <!-- 删除确认弹窗 -->
  <ion-alert
    [isOpen]="isDeleteAlertOpen"
    header="确认删除"
    message="删除后不可恢复，是否继续？"
    [buttons]="alertButtons"
    (didDismiss)="onDeleteAlertDismiss()"
  >
  </ion-alert>

  <!-- 编辑事件弹窗（表单） -->
  <ion-modal [isOpen]="isEditModalOpen" (didDismiss)="closeEditModal()">
    <ng-template>
      <ion-header [translucent]="true">
        <ion-toolbar>
          <ion-title>编辑事件</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="closeEditModal()"
              >关闭</ion-button
            >
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content [fullscreen]="true" class="edit-modal-content">
        <form [formGroup]="editForm">
          <ion-list lines="full">
            <ion-item>
              <ion-label position="stacked">标题 *</ion-label>
              <ion-input
                formControlName="EventTitle"
                placeholder="简明描述（如：上门电脑维修）"
              ></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">类型 *</ion-label>
              <ion-select
                formControlName="EventType"
                interface="popover"
                placeholder="请选择事件类型"
              >
                <ion-select-option [value]="0">求助</ion-select-option>
                <ion-select-option [value]="1">帮助</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">类别 *</ion-label>
              <ion-input
                formControlName="EventCategory"
                placeholder="如：电脑维修"
              ></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">位置 *</ion-label>
              <ion-input
                formControlName="Location"
                placeholder="详细地址"
              ></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">价格 (¥)</ion-label>
              <ion-input
                type="number"
                step="0.01"
                formControlName="Price"
                placeholder="0 表示无偿帮助"
              ></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">详细描述 *</ion-label>
              <ion-textarea
                formControlName="EventDetails"
                [autoGrow]="true"
                placeholder="补充说明需求/服务内容"
              ></ion-textarea>
            </ion-item>

            <ion-item lines="none">
              <ion-label position="stacked">编辑图片（可选）</ion-label>
            </ion-item>

            <div class="photo-upload-area" (click)="triggerEditFileInput()">
              <input
                #editFileInput
                type="file"
                accept="image/*"
                multiple
                (change)="onEditFileSelected($event)"
                style="display: none"
              />

              <div class="photo-preview-container">
                @for (photo of getEditPhotoItems(); track $index) {
                <div class="photo-preview">
                  <img [src]="photo.preview" alt="预览" />
                  <ion-icon
                    name="close-circle"
                    class="remove-photo"
                    (click)="removeEditPhoto(photo.isExisting ? 'existing' : 'new', photo.index); $event.stopPropagation()"
                  ></ion-icon>
                </div>
                } @if (getEditPhotoCount() === 0) {
                <div class="upload-placeholder">
                  <ion-icon name="image-outline"></ion-icon>
                  <p>点击上传照片</p>
                </div>
                } @else if (getEditPhotoCount() < 5) {
                <div class="upload-placeholder">
                  <ion-icon name="add-circle-outline"></ion-icon>
                </div>
                }
              </div>

              <ion-text color="medium" class="upload-hint">
                <p>最多可上传 5 张照片，支持 JPG/PNG</p>
              </ion-text>
            </div>
          </ion-list>

          <div class="modal-actions">
            <ion-button
              type="button"
              fill="outline"
              color="medium"
              (click)="closeEditModal()"
              >取消</ion-button
            >
            <ion-button
              type="button"
              (click)="submitEdit()"
              [disabled]="isSavingEdit"
              >保存</ion-button
            >
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- 用户信息编辑弹窗 -->
  <ion-modal
    [isOpen]="isEditProfileModalOpen"
    (didDismiss)="closeEditProfileModal()"
  >
    <ng-template>
      <ion-header [translucent]="true">
        <ion-toolbar>
          <ion-title>编辑个人资料</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="closeEditProfileModal()"
              >关闭</ion-button
            >
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content [fullscreen]="true" class="edit-profile-modal-content">
        <form [formGroup]="editProfileForm">
          <ion-list lines="full">
            <!-- 头像上传 -->
            <div class="avatar-upload-section">
              <div class="avatar-preview">
                @if (profileAvatarPreview) {
                <img [src]="profileAvatarPreview" alt="头像预览" />
                } @else if (userInfo.avatar) {
                <img [src]="getAssetUrl(userInfo.avatar)" alt="当前头像" />
                } @else {
                <ion-icon name="person-circle"></ion-icon>
                }
              </div>
              <div class="avatar-actions">
                <ion-button size="small" (click)="triggerProfileAvatarInput()">
                  {{ profileAvatarPreview || userInfo.avatar ? '更换头像' :
                  '上传头像' }}
                </ion-button>
                @if (profileAvatarPreview || userInfo.avatar) {
                <ion-button
                  size="small"
                  fill="outline"
                  color="danger"
                  (click)="removeProfileAvatar()"
                >
                  删除
                </ion-button>
                }
              </div>
              <input
                #profileAvatarInput
                type="file"
                accept="image/*"
                style="display: none"
                (change)="onProfileAvatarSelected($event)"
              />
              <p class="avatar-hint">支持jpg/png，最大5MB</p>
            </div>

            <ion-item>
              <ion-label position="floating">用户名 *</ion-label>
              <ion-input
                type="text"
                formControlName="UserName"
                placeholder="请输入用户名（2-20个字符）"
                [maxlength]="20"
              ></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="floating">真实姓名 *</ion-label>
              <ion-input
                type="text"
                formControlName="RealName"
                placeholder="请输入真实姓名（2-20个字符）"
                [maxlength]="20"
              ></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="floating">身份证号 *</ion-label>
              <ion-input
                type="text"
                formControlName="IdCardNumber"
                placeholder="请输入18位身份证号"
                [maxlength]="18"
              ></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="floating">所在地 *</ion-label>
              <ion-input
                type="text"
                formControlName="Location"
                placeholder="例如：广西柳州"
              ></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="floating">出生日期 *</ion-label>
              <ion-input type="date" formControlName="BirthDate"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="floating">个人介绍</ion-label>
              <ion-textarea
                formControlName="Introduction"
                placeholder="简单介绍一下自己吧（选填，最多200字）"
                [maxlength]="200"
                [autoGrow]="true"
                rows="3"
              ></ion-textarea>
            </ion-item>
          </ion-list>

          <div class="hint-text">* 标记为必填项</div>

          <div class="modal-actions">
            <ion-button
              type="button"
              fill="outline"
              color="medium"
              (click)="closeEditProfileModal()"
              >取消</ion-button
            >
            <ion-button
              type="button"
              (click)="submitProfileEdit()"
              [disabled]="isSavingProfile"
              >{{ isSavingProfile ? '保存中...' : '保存' }}</ion-button
            >
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  }
</ion-content>
