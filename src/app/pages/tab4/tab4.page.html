<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title> 个人中心 </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  @if (!isLoggedIn) {
  <!-- 未登录时显示登录提示 -->
  <div class="login-prompt">
    <ion-icon name="person-circle" class="prompt-icon"></ion-icon>
    <h2>欢迎使用 HelpMe</h2>
    <p>登录后查看个人中心</p>
    <div class="auth-buttons">
      <ion-button (click)="openLoginModal()">立即登录</ion-button>
      <ion-button fill="outline" (click)="openRegisterModal()"
        >注册账号</ion-button
      >
    </div>
  </div>
  } @if (isLoggedIn) {
  <!-- 用户信息 -->
  <ion-card class="user-card">
    <ion-item lines="none" class="user-header">
      <ion-avatar slot="start" class="user-avatar">
        @if (userInfo.avatar) {
        <img [src]="getAssetUrl(userInfo.avatar)" alt="avatar" />
        } @else {
        <ion-icon name="person-circle"></ion-icon>
        }
      </ion-avatar>
      <ion-label>
        <div class="user-name-row">
          <span class="user-name">{{ userInfo.name }}</span>
          <ion-badge
            class="verified"
            [color]="getVerificationColor(userInfo.isVerified)"
          >
            {{ userInfo.isVerified }}
          </ion-badge>
        </div>
        <p class="user-meta">地址:{{ userInfo.location }}</p>
        <p class="user-credit">买家评分: {{ (userInfo.buyerRanking || 0) }}</p>
        <p class="user-credit">
          服务评分: {{ (userInfo.serviceRanking || 0) }} · 服务总单数: {{
          userInfo.orderCount || 0 }} · 服务等级: {{ userInfo.providerRole || 0
          }}
        </p>
        <p class="user-credit">个人介绍: {{ userInfo.introduction }}</p>
        <ion-button color="danger" (click)="logout()">
          <ion-icon name="log-out"></ion-icon>
          <span>登出</span>
        </ion-button>
      </ion-label>
    </ion-item>
    <div class="user-actions">
      <ion-button fill="outline" (click)="goToFollow()">
        <ion-icon name="heart-outline"></ion-icon>
        <span>关注({{ userInfo.stats.follows }})</span>
      </ion-button>
      <ion-button fill="outline" (click)="goToFavorites()">
        <ion-icon name="heart"></ion-icon>
        <span>收藏({{ userInfo.stats.favorites }})</span>
      </ion-button>
      <ion-button fill="outline" (click)="goToViews()">
        <ion-icon name="eye"></ion-icon>
        <span>浏览({{ userInfo.stats.views }})</span>
      </ion-button>
    </div>
  </ion-card>
  <!-- 分类标签 -->
  <ion-segment [value]="activeTab" (ionChange)="onTabChange($event)">
    <ion-segment-button value="published">
      <ion-icon name="document-text"></ion-icon>
      <ion-label>我发布的</ion-label>
    </ion-segment-button>
    <ion-segment-button value="inProgress">
      <ion-icon name="time"></ion-icon>
      <ion-label>正进行的</ion-label>
    </ion-segment-button>
    <ion-segment-button value="completed">
      <ion-icon name="checkmark-done"></ion-icon>
      <ion-label>已完成</ion-label>
    </ion-segment-button>
    <ion-segment-button value="review">
      <ion-icon name="star"></ion-icon>
      <ion-label>评价</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- 任务列表 -->
  <div class="tasks-list">
    @for (task of getFilteredTasks(); track task.id) {
    <ion-card class="task-item">
      <ion-item lines="none">
        <ion-icon
          name="document-text"
          slot="start"
          class="task-icon"
        ></ion-icon>
        <ion-label>
          <h2 class="task-title">{{ task.publisher }} · {{ task.title }}</h2>
          <p class="task-meta">发布时间: {{ task.createdAt }}</p>
        </ion-label>
        <ion-badge
          slot="end"
          [color]="getStatusColor(task.status)"
          class="status-badge"
        >
          {{ getStatusText(task.status) }}
        </ion-badge>
      </ion-item>
      <ion-item lines="none" class="task-actions">
        <ion-buttons slot="end">
          @if (task.status === 'published') {
          <ion-button
            [disabled]="deletingIds.has(task.id)"
            (click)="openDeleteAlert(task.id)"
          >
            @if (deletingIds.has(task.id)) { 删除中... } @else { 删除 }
          </ion-button>
          <ion-button (click)="editTask(task.id)">编辑</ion-button>
          } @if (task.status === 'inProgress') {
          <ion-button (click)="viewDetails(task.id)">详情</ion-button>
          } @if (task.status === 'completed') {
          <ion-button
            [disabled]="deletingIds.has(task.id)"
            (click)="openDeleteAlert(task.id)"
          >
            @if (deletingIds.has(task.id)) { 删除中... } @else { 删除 }
          </ion-button>
          <ion-button (click)="viewDetails(task.id)">详情</ion-button>
          } @if (task.status === 'review') {
          <ion-button (click)="goToReview(task.id)">评价</ion-button>
          }
        </ion-buttons>
      </ion-item>
    </ion-card>
    } @if (getFilteredTasks().length === 0) {
    <div class="empty-state">
      <ion-icon name="document-text" class="empty-icon"></ion-icon>
      <ion-text color="medium">
        <p>暂无相关任务</p>
      </ion-text>
    </div>
    }
  </div>

  <!-- 删除确认弹窗 -->
  <ion-alert
    [isOpen]="isDeleteAlertOpen"
    header="确认删除"
    message="删除后不可恢复，是否继续？"
    [buttons]="alertButtons"
    (didDismiss)="onDeleteAlertDismiss()"
  >
  </ion-alert>

  <!-- 编辑事件弹窗（表单） -->
  <ion-modal [isOpen]="isEditModalOpen" (didDismiss)="closeEditModal()">
    <ng-template>
      <ion-header [translucent]="true">
        <ion-toolbar>
          <ion-title>编辑事件</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="closeEditModal()"
              >关闭</ion-button
            >
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="edit-modal-content">
        <form [formGroup]="editForm">
          <ion-list lines="full">
            <ion-item>
              <ion-label position="stacked">标题 *</ion-label>
              <ion-input
                formControlName="EventTitle"
                placeholder="简明描述（如：上门电脑维修）"
              ></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">类型 *</ion-label>
              <ion-select
                formControlName="EventType"
                interface="popover"
                placeholder="请选择事件类型"
              >
                <ion-select-option [value]="0">求助</ion-select-option>
                <ion-select-option [value]="1">帮助</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">类别 *</ion-label>
              <ion-input
                formControlName="EventCategory"
                placeholder="如：电脑维修"
              ></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">位置 *</ion-label>
              <ion-input
                formControlName="Location"
                placeholder="详细地址"
              ></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">价格 (¥)</ion-label>
              <ion-input
                type="number"
                step="0.01"
                formControlName="Price"
                placeholder="0 表示无偿帮助"
              ></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">详细描述 *</ion-label>
              <ion-textarea
                formControlName="EventDetails"
                [autoGrow]="true"
                placeholder="补充说明需求/服务内容"
              ></ion-textarea>
            </ion-item>

            <ion-item lines="none">
              <ion-label position="stacked">编辑图片（可选）</ion-label>
            </ion-item>

            <div class="photo-upload-area" (click)="triggerEditFileInput()">
              <input
                #editFileInput
                type="file"
                accept="image/*"
                multiple
                (change)="onEditFileSelected($event)"
                style="display: none"
              />

              <div class="photo-preview-container">
                @for (photo of getEditPhotoItems(); track $index) {
                <div class="photo-preview">
                  <img [src]="photo.preview" alt="预览" />
                  <ion-icon
                    name="close-circle"
                    class="remove-photo"
                    (click)="removeEditPhoto(photo.isExisting ? 'existing' : 'new', photo.index); $event.stopPropagation()"
                  ></ion-icon>
                </div>
                } @if (getEditPhotoCount() === 0) {
                <div class="upload-placeholder">
                  <ion-icon name="image-outline"></ion-icon>
                  <p>点击上传照片</p>
                </div>
                } @else if (getEditPhotoCount() < 5) {
                <div class="upload-placeholder">
                  <ion-icon name="add-circle-outline"></ion-icon>
                </div>
                }
              </div>

              <ion-text color="medium" class="upload-hint">
                <p>最多可上传 5 张照片，支持 JPG/PNG</p>
              </ion-text>
            </div>
          </ion-list>

          <div class="modal-actions">
            <ion-button
              type="button"
              fill="outline"
              color="medium"
              (click)="closeEditModal()"
              >取消</ion-button
            >
            <ion-button
              type="button"
              (click)="submitEdit()"
              [disabled]="isSavingEdit"
              >保存</ion-button
            >
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  }
</ion-content>
