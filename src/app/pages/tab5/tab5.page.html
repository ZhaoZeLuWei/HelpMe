<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>{{ t.header }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="publish-guide">
  <div class="hero">{{ t.hero }}</div>

  <div class="cards">
    <div class="action-card request-card" (click)="navigateToRequest()">
      <div class="icon-bubble">
        <ion-icon name="hand-left-outline"></ion-icon>
      </div>
      <div class="card-copy">
        <div class="title-line">
          <span class="tag">{{ t.reqTitle }}</span>
        </div>
        <p class="desc">{{ t.reqDesc }}</p>
      </div>
    </div>

    <div class="action-card help-card" (click)="navigateToSupport()">
      <div class="icon-bubble">
        <ion-icon name="heart-outline"></ion-icon>
      </div>
      <div class="card-copy">
        <div class="title-line">
          <span class="tag">{{ t.helpTitle }}</span>
        </div>
        <p class="desc">{{ t.helpDesc }}</p>
      </div>
    </div>

    <div class="action-card identity-card" (click)="navigateToIdentitySelection()">
      <div class="icon-bubble">
        <ion-icon name="shield-checkmark-outline"></ion-icon>
      </div>
      <div class="card-copy">
        <div class="title-line">
          <span class="tag">{{ t.authTitle }}</span>
        </div>
        <p class="desc">{{ t.authDesc }}</p>
      </div>
    </div>
  </div>

  <!-- 求助发布弹窗 -->
  <ion-modal [isOpen]="showRequestModal" (didDismiss)="showRequestModal = false">
    <ng-template>
      <ion-header [translucent]="true">
        <ion-toolbar>
          <ion-title>{{ t.form.reqHeader }}</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="showRequestModal = false">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="modal-content">
        <form [formGroup]="requestForm">
          <ion-list lines="full">
            <ion-item>
              <ion-label position="stacked">{{ t.form.title }} *</ion-label>
              <ion-input formControlName="EventTitle" [placeholder]="t.placeholder.reqTitle"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.category }} *</ion-label>
              <ion-input formControlName="EventCategory" [placeholder]="t.placeholder.reqCat"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.location }} *</ion-label>
              <ion-input formControlName="Location" [placeholder]="t.placeholder.reqLoc"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.price }} (¥)</ion-label>
              <ion-input type="number" step="0.01" formControlName="Price" [placeholder]="t.placeholder.reqPrice"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.details }} *</ion-label>
              <ion-textarea formControlName="EventDetails" [autoGrow]="true" [placeholder]="t.placeholder.reqDetail"></ion-textarea>
            </ion-item>

            <ion-item lines="none">
              <ion-label position="stacked">{{ t.form.uploadPhoto }}</ion-label>
            </ion-item>

            <div class="photo-upload-area" (click)="triggerFileInput('request')">
              <input #requestFileInput type="file" accept="image/*" multiple (change)="onFileSelected($event, 'request')" style="display: none" />
              <div class="photo-preview-container">
                @for (photo of requestPhotos; track $index; let i = $index) {
                <div class="photo-preview">
                  <img [src]="photo" alt="预览" />
                  <ion-icon name="close-circle" class="remove-photo" (click)="removePhoto(i, 'request'); $event.stopPropagation()"></ion-icon>
                </div>
                } @if (requestPhotos.length === 0) {
                <div class="upload-placeholder">
                  <ion-icon name="image-outline"></ion-icon>
                  <p>Click to upload</p>
                </div>
                } @else if (requestPhotos.length < 5) {
                <div class="upload-placeholder">
                  <ion-icon name="add-circle-outline"></ion-icon>
                </div>
                }
              </div>
              <ion-text color="medium" class="upload-hint">
                <p>{{ t.form.uploadHint }}</p>
              </ion-text>
            </div>
          </ion-list>

          <div class="modal-actions">
            <ion-button type="button" fill="outline" color="medium" (click)="showRequestModal = false">{{ t.form.cancel }}</ion-button>
            <ion-button type="button" (click)="submitRequest()" [disabled]="isSubmittingRequest">{{ t.form.submitReq }}</ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- 帮助发布弹窗 -->
  <ion-modal [isOpen]="showHelpModal" (didDismiss)="showHelpModal = false">
    <ng-template>
      <ion-header [translucent]="true">
        <ion-toolbar>
          <ion-title>{{ t.form.helpHeader }}</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="showHelpModal = false">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="modal-content">
        <form [formGroup]="helpForm">
          <ion-list lines="full">
            <ion-item>
              <ion-label position="stacked">{{ t.form.title }} *</ion-label>
              <ion-input formControlName="EventTitle" [placeholder]="t.placeholder.helpTitle"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.category }} *</ion-label>
              <ion-input formControlName="EventCategory" [placeholder]="t.placeholder.helpCat"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.location }} *</ion-label>
              <ion-input formControlName="Location" [placeholder]="t.placeholder.helpLoc"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.price }} (¥) *</ion-label>
              <ion-input type="number" step="0.01" formControlName="Price" [placeholder]="t.placeholder.helpPrice"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.details }} *</ion-label>
              <ion-textarea formControlName="EventDetails" [autoGrow]="true" [placeholder]="t.placeholder.helpDetail"></ion-textarea>
            </ion-item>

            <ion-item lines="none">
              <ion-label position="stacked">{{ t.form.uploadPhoto }}</ion-label>
            </ion-item>

            <div class="photo-upload-area" (click)="triggerFileInput('help')">
              <input #helpFileInput type="file" accept="image/*" multiple (change)="onFileSelected($event, 'help')" style="display: none" />
              <div class="photo-preview-container">
                @for (photo of helpPhotos; track $index; let i = $index) {
                <div class="photo-preview">
                  <img [src]="photo" alt="预览" />
                  <ion-icon name="close-circle" class="remove-photo" (click)="removePhoto(i, 'help'); $event.stopPropagation()"></ion-icon>
                </div>
                } @if (helpPhotos.length === 0) {
                <div class="upload-placeholder">
                  <ion-icon name="image-outline"></ion-icon>
                  <p>Click to upload</p>
                </div>
                } @else if (helpPhotos.length < 5) {
                <div class="upload-placeholder">
                  <ion-icon name="add-circle-outline"></ion-icon>
                </div>
                }
              </div>
              <ion-text color="medium" class="upload-hint">
                <p>{{ t.form.uploadHint }}</p>
              </ion-text>
            </div>
          </ion-list>

          <div class="modal-actions">
            <ion-button type="button" fill="outline" color="medium" (click)="showHelpModal = false">{{ t.form.cancel }}</ion-button>
            <ion-button type="button" (click)="submitHelp()" [disabled]="isSubmittingHelp">{{ t.form.submitHelp }}</ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- 认证资格弹窗 -->
  <ion-modal [isOpen]="showIdentityModal" (didDismiss)="showIdentityModal = false">
    <ng-template>
      <ion-header [translucent]="true">
        <ion-toolbar>
          <ion-title>{{ t.form.authHeader }}</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="showIdentityModal = false">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="modal-content">
        <form [formGroup]="identityForm">
          <ion-list lines="full">
            <ion-item>
              <ion-label position="stacked">{{ t.form.realName }} *</ion-label>
              <ion-input formControlName="RealName" [placeholder]="t.placeholder.realName"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.phone }} *</ion-label>
              <ion-input formControlName="PhoneNumber" type="tel" [readonly]="true" [maxlength]="11" [placeholder]="t.placeholder.phone"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.idCard }} *</ion-label>
              <ion-input formControlName="IdCardNumber" [maxlength]="18" [placeholder]="t.placeholder.idCard"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.area }} *</ion-label>
              <ion-input formControlName="Location" [placeholder]="t.placeholder.area"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.role }} *</ion-label>
              <ion-select formControlName="ProviderRole" interface="popover" [placeholder]="t.form.role">
                <ion-select-option value="1">{{ t.authDesc.split(' ')[0] }}</ion-select-option>
                <ion-select-option value="2">{{ t.authDesc.split(' ')[1] }}</ion-select-option>
                <ion-select-option value="3">{{ t.authDesc.split(' ')[2] }}</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">{{ t.form.intro }}</ion-label>
              <ion-textarea formControlName="Introduction" [autoGrow]="true" [placeholder]="t.placeholder.intro"></ion-textarea>
            </ion-item>

            <ion-item lines="none">
              <ion-label position="stacked">{{ t.form.uploadIdCard }} *</ion-label>
            </ion-item>

            <div class="photo-upload-area" (click)="$event.stopPropagation()">
              <input #idCardFileInput type="file" accept="image/*" multiple (change)="onFileSelected($event, 'idcard')" style="display: none" />
              <div class="photo-preview-container">
                @for (photo of idCardPhotos; track $index; let i = $index) {
                <div class="photo-preview">
                  <img [src]="photo" alt="预览" />
                  <ion-icon name="close-circle" class="remove-photo" (click)="removePhoto(i, 'idcard'); $event.stopPropagation()"></ion-icon>
                </div>
                } @if (idCardPhotos.length === 0) {
                <div class="upload-placeholder" (click)="triggerFileInput('idcard')">
                  <ion-icon name="image-outline"></ion-icon>
                  <p>Click to upload ID</p>
                </div>
                } @else if (idCardPhotos.length < IDCARD_MAX) {
                <div class="upload-placeholder" (click)="triggerFileInput('idcard')">
                  <ion-icon name="add-circle-outline"></ion-icon>
                </div>
                }
              </div>
            </div>

            <ion-item lines="none">
              <ion-label position="stacked">{{ t.form.uploadCert }} *</ion-label>
            </ion-item>

            <div class="photo-upload-area" (click)="$event.stopPropagation()">
              <input #certFileInput type="file" accept="image/*" multiple (change)="onFileSelected($event, 'cert')" style="display: none" />
              <div class="photo-preview-container">
                @for (photo of certPhotos; track $index; let i = $index) {
                <div class="photo-preview">
                  <img [src]="photo" alt="预览" />
                  <ion-icon name="close-circle" class="remove-photo" (click)="removePhoto(i, 'cert'); $event.stopPropagation()"></ion-icon>
                </div>
                } @if (certPhotos.length === 0) {
                <div class="upload-placeholder" (click)="triggerFileInput('cert')">
                  <ion-icon name="image-outline"></ion-icon>
                  <p>Click to upload Cert</p>
                </div>
                } @else if (certPhotos.length < CERT_MAX) {
                <div class="upload-placeholder" (click)="triggerFileInput('cert')">
                  <ion-icon name="add-circle-outline"></ion-icon>
                </div>
                }
              </div>
            </div>
          </ion-list>

          <div class="modal-actions">
            <ion-button type="button" fill="outline" color="medium" (click)="showIdentityModal = false">{{ t.form.cancel }}</ion-button>
            <ion-button type="button" (click)="submitIdentity()" [disabled]="isSubmittingIdentity">{{ t.form.submitAuth }}</ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>