<ion-header [translucent]="true">
  <ion-toolbar color="light">
    <div class="search-container ion-padding">
      <!--
           修改点：添加 [formControl]="filterForm.get('searchText')"
           这样输入的内容就会自动进入表单流，触发 filteredEvents 的计算
      -->
      <input
        type="text"
        class="search-input"
        placeholder="搜索想找的事件..."
        [formControl]="searchControl"
      >
      <!-- 按钮保留，因为有了上面的绑定，输入时列表会自动刷新，点击按钮可以作为手动触发或无操作 -->
      <button>搜索</button>
    </div>

    <!-- 将formGroup绑定到一个容器div上，这样ion-segment也能使用formControlName -->
    <div [formGroup]="filterForm">
      <!-- 绑定表单控件的 category -->
      <ion-segment [scrollable]="true" formControlName="category">
        <ion-segment-button value="全部">
          <ion-label>全部</ion-label>
        </ion-segment-button>
        @for (cat of categories; track cat) {
          <ion-segment-button [value]="cat">
            <ion-label>{{ cat }}</ion-label>
          </ion-segment-button>
        }
      </ion-segment>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- 将整个表单绑定到 DOM -->
  <div [formGroup]="filterForm">

    <!-- 筛选按钮行 -->
    <ion-row class="filter-row">
      <ion-col>
        <ion-button expand="block" fill="clear" size="small" color="dark" (click)="setModal('price', true)">
          <ion-icon slot="start" name="pricetag"></ion-icon>
          价格
        </ion-button>
      </ion-col>
      <ion-col>
        <ion-button expand="block" fill="clear" size="small" color="dark" (click)="setModal('location', true)">
          <ion-icon slot="start" name="location"></ion-icon>
          地点
        </ion-button>
      </ion-col>
      <ion-col>
        <ion-button expand="block" fill="clear" size="small" color="dark" (click)="setModal('demand', true)">
          <ion-icon slot="start" name="call"></ion-icon>
          需求
        </ion-button>
      </ion-col>
      <ion-col>
        <ion-button expand="block" fill="clear" size="small" color="dark" (click)="setModal('advanced', true)">
          <ion-icon slot="start" name="funnel"></ion-icon>
          全部
        </ion-button>
      </ion-col>
    </ion-row>

    <!-- 内容展示区 -->
    <div class="event-list-container">
      @if (filteredEvents().length > 0) {
        @for (event of filteredEvents(); track event.id) {
          <!-- 添加点击事件，触发 Router 跳转 -->
          <ion-card class="custom-card" (click)="goToDetail(event.id)">
            <ion-item lines="none" class="card-header">
              <ion-avatar slot="start">
                <img [src]="event.avatar" />
              </ion-avatar>
              <ion-label>
                <h2>{{ event.userName }} <span class="gender-text">({{ event.gender }})</span></h2>
                <p>{{ event.demandType }}</p>
              </ion-label>
              <ion-badge color="primary" slot="end">{{ event.type }}</ion-badge>
            </ion-item>

            <ion-card-content>
              <h3 class="event-Introduction">{{ event.Introduction }}</h3>
              <div class="detail-row">
                <div class="detail-item">
                  <ion-icon name="cash"></ion-icon>
                  <span>¥{{ event.price }}</span>
                </div>
                <div class="detail-item">
                  <ion-icon name="navigate"></ion-icon>
                  <span>{{ event.locationName }}</span>
                </div>
                <div class="detail-item">
                  <ion-icon name="time"></ion-icon>
                  <span>{{ event.time }}</span>
                </div>
              </div>
            </ion-card-content>

            <!-- 底部增加一个明显的进入详情图标，提示用户可点击 -->
            <ion-row class="card-footer">
              <ion-col text-right>
                <small color="medium">点击查看详情 </small>
                <ion-icon name="chevron-forward" color="medium"></ion-icon>
              </ion-col>
            </ion-row>
          </ion-card>
        }
      } @else {
        <div class="empty-state">
          <ion-icon name="file-tray" size="large" color="medium"></ion-icon>
          <p>暂无符合条件的事件</p>
        </div>
      }
    </div>

    <!-- ==================== 模态框区域 ==================== -->

    <!-- 价格筛选 -->
    <ion-modal [isOpen]="modals().price" (willDismiss)="setModal('price', false)">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>价格筛选</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="setModal('price', false)">关闭</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
          <div formGroupName="priceRange">
            <ion-item>
              <ion-label>最低: {{ filterForm.get('priceRange')?.get('min')?.value }}</ion-label>
              <ion-range formControlName="min" [min]="0" [max]="500" [snaps]="true" color="secondary"></ion-range>
            </ion-item>
            <ion-item>
              <ion-label>最高: {{ filterForm.get('priceRange')?.get('max')?.value }}</ion-label>
              <ion-range formControlName="max" [min]="0" [max]="1000" [snaps]="true" color="secondary"></ion-range>
            </ion-item>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>

    <!-- 地点筛选 -->
    <ion-modal [isOpen]="modals().location" (willDismiss)="setModal('location', false)">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>选择地点</ion-title>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <ion-grid>
            <ion-row class="full-height">
              <ion-col size="3.5" class="sidebar">
                <div class="sidebar-item">社区</div>
                <div class="sidebar-item active">学校</div>
              </ion-col>
              <ion-col size="8.5">
                <div formGroupName="location">
                  <ion-list>
                    <ion-item [button]="true" (click)="filterForm.patchValue({ location: { name: '001社区' } }); setModal('location', false)">
                      <ion-label>001社区</ion-label>
                    </ion-item>
                    <ion-item [button]="true" (click)="filterForm.patchValue({ location: { name: '广科社区' } }); setModal('location', false)">
                      <ion-label>广科社区</ion-label>
                    </ion-item>
                  </ion-list>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-content>
      </ng-template>
    </ion-modal>

    <!-- 需求筛选 -->
    <ion-modal [isOpen]="modals().demand" (willDismiss)="setModal('demand', false)">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>需求类型</ion-title>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <ion-list>
            <ion-item [button]="true" lines="full" (click)="filterForm.patchValue({ demand: '求助' }); setModal('demand', false)">
              <ion-label>求助</ion-label>
            </ion-item>
            <ion-item [button]="true" lines="full" (click)="filterForm.patchValue({ demand: '帮助' }); setModal('demand', false)">
              <ion-label>帮助</ion-label>
            </ion-item>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-modal>

    <!-- 全部/详细筛选 -->
    <ion-modal [isOpen]="modals().advanced" (willDismiss)="setModal('advanced', false)">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>详细筛选</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="resetFilters()" [strong]="true">重置</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <div formGroupName="advanced">
            <ion-list-header>时间</ion-list-header>
            <ion-segment formControlName="time">
              <ion-segment-button value="">
                <ion-label>不限</ion-label>
              </ion-segment-button>
              <ion-segment-button value="14:00">
                <ion-label>14:00</ion-label>
              </ion-segment-button>
              <ion-segment-button value="17:00">
                <ion-label>17:00</ion-label>
              </ion-segment-button>
            </ion-segment>

            <ion-list-header>事件关键词</ion-list-header>
            <!-- 这里输入时，RxJS debounceTime(300) 会生效，不会频繁刷新列表 -->
            <ion-searchbar formControlName="keyword" placeholder="搜索关键词 (如: 修理, 买药)..."></ion-searchbar>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>

  </div>
</ion-content>
